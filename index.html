<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Garantias - Auto Peças</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Dim background */
        }
        .modal-content {
            background-color: #ffffff;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px; /* Max width for larger screens */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .table-responsive {
            overflow-x: auto;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .btn {
            @apply py-2 px-4 rounded-md font-semibold text-white shadow-md transition-colors duration-150;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700;
        }
        .btn-success {
            @apply bg-green-600 hover:bg-green-700;
        }
        .input-field {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700;
        }
        .card {
            @apply bg-white shadow-lg rounded-lg p-6;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4">
        <header class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-blue-700">Sistema de Controle de Garantias</h1>
                <div class="text-sm text-gray-600 mt-2 sm:mt-0">
                    UserID: <span id="userIdDisplay" class="font-semibold">Carregando...</span>
                </div>
            </div>
        </header>

        <nav class="bg-white shadow-md rounded-lg mb-6">
            <ul class="flex flex-wrap border-b border-gray-200">
                <li class="mr-1">
                    <button data-tab="dashboard" class="tab-button bg-white inline-block py-3 px-5 text-blue-600 hover:text-blue-800 font-semibold border-b-2 border-blue-600 rounded-t-lg">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                </li>
                <li class="mr-1">
                    <button data-tab="products" class="tab-button text-gray-600 hover:text-blue-700 inline-block py-3 px-5 font-semibold rounded-t-lg">
                        <i class="fas fa-box mr-2"></i>Produtos
                    </button>
                </li>
                <li class="mr-1">
                    <button data-tab="customers" class="tab-button text-gray-600 hover:text-blue-700 inline-block py-3 px-5 font-semibold rounded-t-lg">
                        <i class="fas fa-users mr-2"></i>Clientes
                    </button>
                </li>
                <li class="mr-1">
                    <button data-tab="suppliers" class="tab-button text-gray-600 hover:text-blue-700 inline-block py-3 px-5 font-semibold rounded-t-lg">
                        <i class="fas fa-truck mr-2"></i>Fornecedores
                    </button>
                </li>
                <li class="mr-1">
                    <button data-tab="mechanics" class="tab-button text-gray-600 hover:text-blue-700 inline-block py-3 px-5 font-semibold rounded-t-lg">
                        <i class="fas fa-wrench mr-2"></i>Mecânicos
                    </button>
                </li>
                <li>
                    <button data-tab="warranties" class="tab-button text-gray-600 hover:text-blue-700 inline-block py-3 px-5 font-semibold rounded-t-lg">
                        <i class="fas fa-shield-alt mr-2"></i>Garantias
                    </button>
                </li>
            </ul>
        </nav>

        <main id="tabContentContainer">
            <div id="dashboardContent" class="tab-content active card">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Dashboard</h2>
                <p class="text-gray-600">Bem-vindo ao Sistema de Controle de Garantias. Selecione uma aba para começar.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-blue-700">Total de Produtos</h3>
                        <p id="totalProducts" class="text-2xl">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-green-700">Total de Clientes</h3>
                        <p id="totalCustomers" class="text-2xl">0</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-yellow-700">Garantias Ativas</h3>
                        <p id="activeWarranties" class="text-2xl">0</p>
                    </div>
                </div>
            </div>

            <div id="productsContent" class="tab-content card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Produtos</h2>
                    <button id="addProductBtn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Produto</button>
                </div>
                <div class="table-responsive">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cód. Peça</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fornecedor</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Venda</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Garantia</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y divide-gray-200">
                            <tr><td colspan="6" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="customersContent" class="tab-content card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Clientes</h2>
                    <button id="addCustomerBtn" class="btn btn-primary"><i class="fas fa-user-plus mr-2"></i>Adicionar Cliente</button>
                </div>
                <div class="table-responsive">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPF</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody" class="divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="suppliersContent" class="tab-content card">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Fornecedores</h2>
                    <button id="addSupplierBtn" class="btn btn-primary"><i class="fas fa-plus-circle mr-2"></i>Adicionar Fornecedor</button>
                </div>
                <div class="table-responsive">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CNPJ</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTableBody" class="divide-y divide-gray-200">
                           <tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="mechanicsContent" class="tab-content card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Mecânicos</h2>
                    <button id="addMechanicBtn" class="btn btn-primary"><i class="fas fa-user-cog mr-2"></i>Adicionar Mecânico</button>
                </div>
                <div class="table-responsive">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPF/CNPJ</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Oficina</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="mechanicsTableBody" class="divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="warrantiesContent" class="tab-content card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Garantias</h2>
                    <button id="addWarrantyBtn" class="btn btn-primary"><i class="fas fa-plus-square mr-2"></i>Registrar Garantia</button>
                </div>
                <div class="table-responsive">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Venda</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="warrantiesTableBody" class="divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-semibold"></h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="genericForm">
                </form>
            <div id="formFeedback" class="mt-3 text-sm"></div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content max-w-sm">
            <h3 id="confirmModalTitle" class="text-lg font-semibold mb-4">Confirmar Ação</h3>
            <p id="confirmModalMessage" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirmModalCancelBtn" class="btn btn-secondary">Cancelar</button>
                <button id="confirmModalConfirmBtn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content max-w-sm">
             <div class="flex justify-between items-center mb-4">
                <h3 id="messageModalTitle" class="text-lg font-semibold">Mensagem</h3>
                <button id="messageModalCloseBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <p id="messageModalText" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button id="messageModalOkBtn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

        // --- Firebase Configuration (Directly from user) ---
        // !! IMPORTANTE !! Verifique CUIDADOSAMENTE se esta configuração é IDÊNTICA
        // à configuração do seu app web no Firebase Console (Configurações do Projeto > Seus apps > Snippet do SDK > Config).
        // Verifique também as RESTRIÇÕES DA SUA API KEY no Google Cloud Console:
        // 1. Vá para https://console.cloud.google.com/ -> APIs e Serviços > Credenciais
        // 2. Encontre a API Key usada abaixo.
        // 3. Restrições de aplicativo: Para teste, defina como "Nenhuma" ou adicione seu domínio de teste (ex: http://localhost:PORTA).
        // 4. Restrições de API: Para teste, defina como "Não restringir chave" ou permita "Identity Toolkit API" e "Cloud Firestore API".
        const firebaseConfig = {
            apiKey: "AIzaSyA2LYkRo6jxV7Za7DFW1Mmy_IFavSecInA",
            authDomain: "controle-garantia.firebaseapp.com",
            projectId: "controle-garantia",
            storageBucket: "controle-garantia.firebasestorage.app",
            messagingSenderId: "753625861980",
            appId: "1:753625861980:web:d5c2423575d1d9c077fb99",
            measurementId: "G-EM566F23CN"
        };
        console.log("Firebase Config sendo usada:", JSON.parse(JSON.stringify(firebaseConfig)));

        const firestoreAppId = firebaseConfig.projectId;

        let app;
        let auth;
        let db;
        let userId = null;
        let isAuthReady = false;

        async function initializeFirebase() {
            try {
                console.log("Tentando inicializar Firebase...");
                app = initializeApp(firebaseConfig);
                console.log("Firebase App inicializado:", app.name);
                db = getFirestore(app);
                console.log("Firestore DB inicializado.");
                auth = getAuth(app);
                console.log("Firebase Auth inicializado.");
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("onAuthStateChanged: User is signed in:", user.uid, user);
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        isAuthReady = true;
                        loadCurrentTabData();
                        loadDashboardData();
                    } else {
                        console.log("onAuthStateChanged: User is signed out. Attempting to sign in anonymously.");
                        // IMPORTANTE: Para o erro "auth/configuration-not-found",
                        // verifique se o método de login anônimo está HABILITADO
                        // no seu Firebase Console (Authentication > Sign-in method).
                        // E também verifique as restrições da API Key no Google Cloud Console.
                        try {
                            // Forçando login anônimo para diagnóstico
                            // if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            //     console.log("Attempting sign in with custom token.");
                            //     await signInWithCustomToken(auth, __initial_auth_token);
                            // } else {
                                console.log("Tentando signInAnonymously...");
                                await signInAnonymously(auth);
                                console.log("signInAnonymously tentado. auth.currentUser:", auth.currentUser);
                                // O estado do usuário será atualizado pelo onAuthStateChanged se o login anônimo for bem-sucedido.
                                // Não definimos isAuthReady aqui, pois esperamos o callback do onAuthStateChanged.
                            // }
                        } catch (error) {
                            console.error("Erro CRÍTICO durante signInAnonymously:", error);
                            document.getElementById('userIdDisplay').textContent = "Erro de autenticação";
                            showModalMessage("Erro de Autenticação", `Não foi possível autenticar anonimamente: ${error.message} (Código: ${error.code}). Verifique a configuração do Firebase, as restrições da API Key e se o método de login anônimo está habilitado no console.`);
                            isAuthReady = false; // Sinaliza que a autenticação falhou
                        }
                    }
                });

            } catch (error) {
                console.error("Erro CRÍTICO ao inicializar Firebase:", error);
                showModalMessage("Erro de Inicialização", `Firebase não pôde ser inicializado: ${error.message}. Verifique a configuração no código e no console.`);
                document.getElementById('userIdDisplay').textContent = "Falha na inicialização";
                isAuthReady = false;
            }
        }

        // --- Global Variables & DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const modal = document.getElementById('formModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const genericForm = document.getElementById('genericForm');
        const modalTitle = document.getElementById('modalTitle');
        const formFeedback = document.getElementById('formFeedback');

        const confirmModal = document.getElementById('confirmModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
        const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
        let confirmCallback = null;

        const messageModal = document.getElementById('messageModal');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalText = document.getElementById('messageModalText');
        const messageModalCloseBtn = document.getElementById('messageModalCloseBtn');
        const messageModalOkBtn = document.getElementById('messageModalOkBtn');

        // --- Collections ---
        const COLLECTIONS = {
            PRODUCTS: 'products',
            CUSTOMERS: 'customers',
            SUPPLIERS: 'suppliers',
            MECHANICS: 'mechanics',
            WARRANTIES: 'warranties'
        };

        function getCollectionPath(collectionName) {
            if (!firestoreAppId) {
                console.error("firestoreAppId não está definido! Verifique a firebaseConfig.");
                throw new Error("Configuração do App ID do Firestore ausente.");
            }
            return `artifacts/${firestoreAppId}/public/data/${collectionName}`;
        }

        // --- Modal Management ---
        function openModal(title, formHTML, submitHandler, currentData = null) {
            if (!isAuthReady) {
                showModalMessage("Autenticação Pendente", "Aguarde a conclusão da autenticação com o Firebase antes de prosseguir.");
                return;
            }
            modalTitle.textContent = title;
            genericForm.innerHTML = formHTML;
            genericForm.onsubmit = async (e) => {
                e.preventDefault();
                if (!isAuthReady || !userId) {
                     showModalMessage("Erro de Autenticação", "Usuário não autenticado. Não é possível salvar os dados.");
                     return;
                }
                formFeedback.textContent = '';
                const formData = new FormData(genericForm);
                const data = Object.fromEntries(formData.entries());
                try {
                    await submitHandler(data, currentData ? currentData.id : null);
                    closeModal();
                    showModalMessage("Sucesso", "Operação realizada com sucesso!");
                } catch (error) {
                    console.error("Form submission error:", error);
                    formFeedback.textContent = `Erro: ${error.message}`;
                    showModalMessage("Erro na Operação", `Ocorreu um erro: ${error.message}`);
                }
            };
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
            genericForm.reset();
            formFeedback.textContent = '';
        }

        closeModalBtn.onclick = closeModal;
        window.onclick = (event) => {
            if (event.target == modal) closeModal();
            if (event.target == confirmModal) closeConfirmModal();
            if (event.target == messageModal) closeMessageModal();
        };

        function showConfirmModal(title, message, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.style.display = 'block';
        }

        function closeConfirmModal() {
            confirmModal.style.display = 'none';
            confirmCallback = null;
        }

        confirmModalCancelBtn.onclick = closeConfirmModal;
        confirmModalConfirmBtn.onclick = () => {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        };

        function showModalMessage(title, text) {
            messageModalTitle.textContent = title;
            messageModalText.textContent = text;
            messageModal.style.display = 'block';
        }

        function closeMessageModal() {
            messageModal.style.display = 'none';
        }
        messageModalCloseBtn.onclick = closeMessageModal;
        messageModalOkBtn.onclick = closeMessageModal;


        // --- Tab Navigation ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!isAuthReady) {
                    showModalMessage("Aguarde", "A autenticação com o Firebase ainda está em progresso ou falhou.");
                    return;
                }
                const tabName = button.dataset.tab;

                tabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('text-gray-600', 'hover:text-blue-700');
                });
                button.classList.add('border-blue-600', 'text-blue-600');
                button.classList.remove('text-gray-600', 'hover:text-blue-700');

                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Content`).classList.add('active');
                loadCurrentTabData();
            });
        });

        function getActiveTab() {
            const activeButton = document.querySelector('.tab-button.border-blue-600');
            return activeButton ? activeButton.dataset.tab : 'dashboard';
        }

        function loadCurrentTabData() {
            if (!isAuthReady || !db || !userId) { // Adicionado cheque de userId
                console.log("Auth/DB não pronto ou usuário não logado. Pulando carregamento de dados da aba.");
                if (!isAuthReady) showModalMessage("Aguarde", "A autenticação com o Firebase ainda está em progresso ou falhou.");
                else if (!userId) showModalMessage("Erro", "Usuário não autenticado. Não é possível carregar dados.");
                return;
            }
            const activeTab = getActiveTab();
            console.log(`Carregando dados para aba ativa: ${activeTab}`);
            switch (activeTab) {
                case 'products': loadProducts(); break;
                case 'customers': loadCustomers(); break;
                case 'suppliers': loadSuppliers(); break;
                case 'mechanics': loadMechanics(); break;
                case 'warranties': loadWarranties(); break;
                case 'dashboard': loadDashboardData(); break;
            }
        }

        // --- CRUD Operations ---
        async function addData(collectionName, data) {
            if (!db) throw new Error("Banco de dados não inicializado.");
            if (!auth.currentUser) throw new Error("Usuário não autenticado. Não é possível adicionar dados.");
            console.log(`Adicionando dados à coleção ${collectionName}:`, data);
            return await addDoc(collection(db, getCollectionPath(collectionName)), data);
        }

        async function getData(collectionName) {
            if (!db) throw new Error("Banco de dados não inicializado.");
            if (!auth.currentUser) { // Adicionado para consistência, embora regras de segurança devam proteger
                 console.warn("Tentando ler dados sem usuário autenticado (getData).");
                 // Dependendo das regras, isso pode falhar ou retornar vazio.
            }
            console.log(`Buscando dados da coleção ${collectionName}`);
            const querySnapshot = await getDocs(collection(db, getCollectionPath(collectionName)));
            const dataList = [];
            querySnapshot.forEach((doc) => {
                dataList.push({ id: doc.id, ...doc.data() });
            });
            console.log(`Dados recebidos de ${collectionName}:`, dataList.length, "itens");
            return dataList;
        }

        async function updateData(collectionName, id, data) {
            if (!db) throw new Error("Banco de dados não inicializado.");
            if (!auth.currentUser) throw new Error("Usuário não autenticado. Não é possível atualizar dados.");
            const docRef = doc(db, getCollectionPath(collectionName), id);
            return await updateDoc(docRef, data);
        }

        async function deleteData(collectionName, id) {
            if (!db) throw new Error("Banco de dados não inicializado.");
            if (!auth.currentUser) throw new Error("Usuário não autenticado. Não é possível deletar dados.");
            return await deleteDoc(doc(db, getCollectionPath(collectionName), id));
        }

        // --- Product Management ---
        const productsTableBody = document.getElementById('productsTableBody');
        const addProductBtn = document.getElementById('addProductBtn');

        const productFormHTML = (product = {}) => `
            <input type="hidden" name="id" value="${product.id || ''}">
            <div><label for="productName" class="form-label">Nome do Produto:</label><input type="text" id="productName" name="name" class="input-field" value="${product.name || ''}" required></div>
            <div class="mt-4"><label for="productPartNumber" class="form-label">Código da Peça:</label><input type="text" id="productPartNumber" name="partNumber" class="input-field" value="${product.partNumber || ''}"></div>
            <div class="mt-4"><label for="productSupplierId" class="form-label">Fornecedor:</label><select id="productSupplierId" name="supplierId" class="input-field"></select></div>
            <div class="mt-4 grid grid-cols-2 gap-4">
                <div><label for="productCostPrice" class="form-label">Preço de Custo (R$):</label><input type="number" step="0.01" id="productCostPrice" name="costPrice" class="input-field" value="${product.costPrice || ''}"></div>
                <div><label for="productSellingPrice" class="form-label">Preço de Venda (R$):</label><input type="number" step="0.01" id="productSellingPrice" name="sellingPrice" class="input-field" value="${product.sellingPrice || ''}" required></div>
            </div>
            <div class="mt-4"><label for="productWarrantyPeriod" class="form-label">Período de Garantia (ex: 3 meses, 1 ano):</label><input type="text" id="productWarrantyPeriod" name="warrantyPeriod" class="input-field" value="${product.warrantyPeriod || ''}"></div>
            <button type="submit" class="btn btn-primary mt-6 w-full">${product.id ? 'Atualizar' : 'Salvar'} Produto</button>
        `;

        async function populateSupplierDropdown(selectElementId, selectedSupplierId = null) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;
            selectElement.innerHTML = '<option value="">Carregando fornecedores...</option>';
            try {
                const suppliers = await getData(COLLECTIONS.SUPPLIERS);
                if (suppliers.length === 0) {
                    selectElement.innerHTML = '<option value="">Nenhum fornecedor cadastrado</option>'; return;
                }
                selectElement.innerHTML = '<option value="">Selecione um Fornecedor</option>';
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id; option.textContent = supplier.name;
                    if (supplier.id === selectedSupplierId) option.selected = true;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error("Error populating suppliers:", error);
                selectElement.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        addProductBtn.onclick = () => {
            openModal('Adicionar Novo Produto', productFormHTML(), async (data) => {
                await addData(COLLECTIONS.PRODUCTS, data); loadProducts();
            });
            populateSupplierDropdown('productSupplierId');
        };
        async function editProduct(product) {
            openModal('Editar Produto', productFormHTML(product), async (data) => {
                await updateData(COLLECTIONS.PRODUCTS, product.id, data); loadProducts();
            }, product);
            populateSupplierDropdown('productSupplierId', product.supplierId);
        }
        async function deleteProduct(productId, productName) {
            showConfirmModal('Confirmar Exclusão', `Tem certeza que deseja excluir o produto "${productName}"?`, async () => {
                try {
                    const q = query(collection(db, getCollectionPath(COLLECTIONS.WARRANTIES)), where("productId", "==", productId));
                    const warrantySnapshot = await getDocs(q);
                    if (!warrantySnapshot.empty) {
                        showModalMessage("Erro", `Produto "${productName}" associado a ${warrantySnapshot.size} garantia(s).`); return;
                    }
                    await deleteData(COLLECTIONS.PRODUCTS, productId);
                    showModalMessage("Sucesso", `Produto "${productName}" excluído.`); loadProducts();
                } catch (error) { showModalMessage("Erro", `Excluir produto: ${error.message}`); }
            });
        }
        async function loadProducts() {
            if (!isAuthReady || !db) return;
            productsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';
            try {
                const products = await getData(COLLECTIONS.PRODUCTS);
                const suppliers = await getData(COLLECTIONS.SUPPLIERS);
                const supplierMap = suppliers.reduce((map, s) => { map[s.id] = s.name; return map; }, {});
                if (products.length === 0) {
                    productsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Nenhum produto.</td></tr>'; return;
                }
                productsTableBody.innerHTML = '';
                products.forEach(p => {
                    const row = productsTableBody.insertRow();
                    row.innerHTML = `<td class="py-3 px-4">${p.name||'N/A'}</td><td class="py-3 px-4">${p.partNumber||'N/A'}</td><td class="py-3 px-4">${supplierMap[p.supplierId]||p.supplierId||'N/A'}</td><td class="py-3 px-4">R$ ${parseFloat(p.sellingPrice||0).toFixed(2)}</td><td class="py-3 px-4">${p.warrantyPeriod||'N/A'}</td><td class="py-3 px-4 whitespace-nowrap"><button class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td>`;
                    row.querySelector('.fa-edit').parentElement.onclick = () => editProduct(p);
                    row.querySelector('.fa-trash').parentElement.onclick = () => deleteProduct(p.id, p.name);
                });
            } catch (e) { productsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Erro: ${e.message}</td></tr>`; }
        }

        // --- Customer Management ---
        const customersTableBody = document.getElementById('customersTableBody');
        const addCustomerBtn = document.getElementById('addCustomerBtn');
        const customerFormHTML = (c={}) => `<input type="hidden" name="id" value="${c.id||''}"><div class="mt-4"><label class="form-label">Nome:</label><input type="text" name="name" class="input-field" value="${c.name||''}" required></div><div class="mt-4"><label class="form-label">CPF:</label><input type="text" name="cpf" class="input-field" value="${c.cpf||''}"></div><div class="mt-4"><label class="form-label">Telefone:</label><input type="tel" name="phone" class="input-field" value="${c.phone||''}"></div><div class="mt-4"><label class="form-label">Email:</label><input type="email" name="email" class="input-field" value="${c.email||''}"></div><div class="mt-4"><label class="form-label">Endereço:</label><input type="text" name="address" class="input-field" value="${c.address||''}"></div><button type="submit" class="btn btn-primary mt-6 w-full">${c.id?'Atualizar':'Salvar'} Cliente</button>`;
        addCustomerBtn.onclick=()=>{openModal('Novo Cliente',customerFormHTML(),async d=>{await addData(COLLECTIONS.CUSTOMERS,d);loadCustomers();});};
        async function editCustomer(c){openModal('Editar Cliente',customerFormHTML(c),async d=>{await updateData(COLLECTIONS.CUSTOMERS,c.id,d);loadCustomers();},c);}
        async function deleteCustomer(id,name){showConfirmModal('Excluir',`Excluir cliente "${name}"?`,async()=>{try{const q=query(collection(db,getCollectionPath(COLLECTIONS.WARRANTIES)),where("customerId","==",id));const snap=await getDocs(q);if(!snap.empty){showModalMessage("Erro",`Cliente "${name}" associado a ${snap.size} garantia(s).`);return;}await deleteData(COLLECTIONS.CUSTOMERS,id);showModalMessage("Sucesso",`Cliente "${name}" excluído.`);loadCustomers();}catch(e){showModalMessage("Erro",`Excluir cliente: ${e.message}`);}});};
        async function loadCustomers(){if(!isAuthReady||!db)return;customersTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';try{const l=await getData(COLLECTIONS.CUSTOMERS);if(l.length===0){customersTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4">Nenhum cliente.</td></tr>';return;}customersTableBody.innerHTML='';l.forEach(c=>{const r=customersTableBody.insertRow();r.innerHTML=`<td class="py-3 px-4">${c.name||'N/A'}</td><td class="py-3 px-4">${c.cpf||'N/A'}</td><td class="py-3 px-4">${c.phone||'N/A'}</td><td class="py-3 px-4">${c.email||'N/A'}</td><td class="py-3 px-4"><button class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button><button class="text-red-600"><i class="fas fa-trash"></i></button></td>`;r.querySelector('.fa-edit').parentElement.onclick=()=>editCustomer(c);r.querySelector('.fa-trash').parentElement.onclick=()=>deleteCustomer(c.id,c.name);});}catch(e){customersTableBody.innerHTML=`<tr><td colspan="5" class="text-center py-4 text-red-500">Erro: ${e.message}</td></tr>`;}}

        // --- Supplier Management ---
        const suppliersTableBody = document.getElementById('suppliersTableBody');
        const addSupplierBtn = document.getElementById('addSupplierBtn');
        const supplierFormHTML=(s={})=>`<input type="hidden" name="id" value="${s.id||''}"><div class="mt-4"><label class="form-label">Nome:</label><input type="text" name="name" class="input-field" value="${s.name||''}" required></div><div class="mt-4"><label class="form-label">CNPJ:</label><input type="text" name="cnpj" class="input-field" value="${s.cnpj||''}"></div><div class="mt-4"><label class="form-label">Telefone:</label><input type="tel" name="phone" class="input-field" value="${s.phone||''}"></div><div class="mt-4"><label class="form-label">Email:</label><input type="email" name="email" class="input-field" value="${s.email||''}"></div><div class="mt-4"><label class="form-label">Endereço:</label><input type="text" name="address" class="input-field" value="${s.address||''}"></div><button type="submit" class="btn btn-primary mt-6 w-full">${s.id?'Atualizar':'Salvar'} Fornecedor</button>`;
        addSupplierBtn.onclick=()=>{openModal('Novo Fornecedor',supplierFormHTML(),async d=>{await addData(COLLECTIONS.SUPPLIERS,d);loadSuppliers();});};
        async function editSupplier(s){openModal('Editar Fornecedor',supplierFormHTML(s),async d=>{await updateData(COLLECTIONS.SUPPLIERS,s.id,d);loadSuppliers();},s);}
        async function deleteSupplier(id,name){showConfirmModal('Excluir',`Excluir fornecedor "${name}"?`,async()=>{try{const q=query(collection(db,getCollectionPath(COLLECTIONS.PRODUCTS)),where("supplierId","==",id));const snap=await getDocs(q);if(!snap.empty){showModalMessage("Erro",`Fornecedor "${name}" associado a ${snap.size} produto(s).`);return;}await deleteData(COLLECTIONS.SUPPLIERS,id);showModalMessage("Sucesso",`Fornecedor "${name}" excluído.`);loadSuppliers();}catch(e){showModalMessage("Erro",`Excluir fornecedor: ${e.message}`);}});};
        async function loadSuppliers(){if(!isAuthReady||!db)return;suppliersTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';try{const l=await getData(COLLECTIONS.SUPPLIERS);if(l.length===0){suppliersTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4">Nenhum fornecedor.</td></tr>';return;}suppliersTableBody.innerHTML='';l.forEach(s=>{const r=suppliersTableBody.insertRow();r.innerHTML=`<td class="py-3 px-4">${s.name||'N/A'}</td><td class="py-3 px-4">${s.cnpj||'N/A'}</td><td class="py-3 px-4">${s.phone||'N/A'}</td><td class="py-3 px-4">${s.email||'N/A'}</td><td class="py-3 px-4"><button class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button><button class="text-red-600"><i class="fas fa-trash"></i></button></td>`;r.querySelector('.fa-edit').parentElement.onclick=()=>editSupplier(s);r.querySelector('.fa-trash').parentElement.onclick=()=>deleteSupplier(s.id,s.name);});}catch(e){suppliersTableBody.innerHTML=`<tr><td colspan="5" class="text-center py-4 text-red-500">Erro: ${e.message}</td></tr>`;}}

        // --- Mechanic Management ---
        const mechanicsTableBody = document.getElementById('mechanicsTableBody');
        const addMechanicBtn = document.getElementById('addMechanicBtn');
        const mechanicFormHTML=(m={})=>`<input type="hidden" name="id" value="${m.id||''}"><div class="mt-4"><label class="form-label">Nome:</label><input type="text" name="name" class="input-field" value="${m.name||''}" required></div><div class="mt-4"><label class="form-label">CPF/CNPJ:</label><input type="text" name="cpf_cnpj" class="input-field" value="${m.cpf_cnpj||''}"></div><div class="mt-4"><label class="form-label">Telefone:</label><input type="tel" name="phone" class="input-field" value="${m.phone||''}"></div><div class="mt-4"><label class="form-label">Oficina:</label><input type="text" name="workshopName" class="input-field" value="${m.workshopName||''}"></div><button type="submit" class="btn btn-primary mt-6 w-full">${m.id?'Atualizar':'Salvar'} Mecânico</button>`;
        addMechanicBtn.onclick=()=>{openModal('Novo Mecânico',mechanicFormHTML(),async d=>{await addData(COLLECTIONS.MECHANICS,d);loadMechanics();});};
        async function editMechanic(m){openModal('Editar Mecânico',mechanicFormHTML(m),async d=>{await updateData(COLLECTIONS.MECHANICS,m.id,d);loadMechanics();},m);}
        async function deleteMechanic(id,name){showConfirmModal('Excluir',`Excluir mecânico "${name}"?`,async()=>{try{const q=query(collection(db,getCollectionPath(COLLECTIONS.WARRANTIES)),where("mechanicId","==",id));const snap=await getDocs(q);if(!snap.empty){showModalMessage("Erro",`Mecânico "${name}" associado a ${snap.size} garantia(s).`);return;}await deleteData(COLLECTIONS.MECHANICS,id);showModalMessage("Sucesso",`Mecânico "${name}" excluído.`);loadMechanics();}catch(e){showModalMessage("Erro",`Excluir mecânico: ${e.message}`);}});};
        async function loadMechanics(){if(!isAuthReady||!db)return;mechanicsTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';try{const l=await getData(COLLECTIONS.MECHANICS);if(l.length===0){mechanicsTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4">Nenhum mecânico.</td></tr>';return;}mechanicsTableBody.innerHTML='';l.forEach(m=>{const r=mechanicsTableBody.insertRow();r.innerHTML=`<td class="py-3 px-4">${m.name||'N/A'}</td><td class="py-3 px-4">${m.cpf_cnpj||'N/A'}</td><td class="py-3 px-4">${m.phone||'N/A'}</td><td class="py-3 px-4">${m.workshopName||'N/A'}</td><td class="py-3 px-4"><button class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button><button class="text-red-600"><i class="fas fa-trash"></i></button></td>`;r.querySelector('.fa-edit').parentElement.onclick=()=>editMechanic(m);r.querySelector('.fa-trash').parentElement.onclick=()=>deleteMechanic(m.id,m.name);});}catch(e){mechanicsTableBody.innerHTML=`<tr><td colspan="5" class="text-center py-4 text-red-500">Erro: ${e.message}</td></tr>`;}}

        // --- Warranty Management ---
        const warrantiesTableBody = document.getElementById('warrantiesTableBody');
        const addWarrantyBtn = document.getElementById('addWarrantyBtn');
        const warrantyStatusOptions = ["Em análise", "Aprovada", "Recusada", "Produto trocado", "Reparado", "Aguardando peça", "Finalizada"];
        const warrantyFormHTML=(w={})=>`<input type="hidden" name="id" value="${w.id||''}"><div class="mt-4"><label class="form-label">Produto:</label><select name="productId" id="warrantyProductId" class="input-field" required></select></div><div class="mt-4"><label class="form-label">Cliente:</label><select name="customerId" id="warrantyCustomerId" class="input-field" required></select></div><div class="mt-4"><label class="form-label">Mecânico (opc.):</label><select name="mechanicId" id="warrantyMechanicId" class="input-field"></select></div><div class="mt-4"><label class="form-label">Data Venda:</label><input type="date" name="saleDate" class="input-field" value="${w.saleDate||''}" required></div><div class="mt-4"><label class="form-label">Nota Fiscal:</label><input type="text" name="invoiceNumber" class="input-field" value="${w.invoiceNumber||''}"></div><div class="mt-4"><label class="form-label">Problema:</label><textarea name="problemDescription" class="input-field" rows="3" required>${w.problemDescription||''}</textarea></div><div class="mt-4"><label class="form-label">Status:</label><select name="status" class="input-field" required>${warrantyStatusOptions.map(s=>`<option value="${s}" ${w.status===s?'selected':''}>${s}</option>`).join('')}</select></div><div class="mt-4"><label class="form-label">Data Resolução:</label><input type="date" name="resolutionDate" class="input-field" value="${w.resolutionDate||''}"></div><div class="mt-4"><label class="form-label">Obs:</label><textarea name="notes" class="input-field" rows="2">${w.notes||''}</textarea></div><button type="submit" class="btn btn-primary mt-6 w-full">${w.id?'Atualizar':'Salvar'} Garantia</button>`;
        async function populateSelectWithOptions(elId,coll,nameF,selId=null,place="Selecione"){const el=document.getElementById(elId);if(!el)return;el.innerHTML=`<option value="">Carregando...</option>`;try{const items=await getData(coll);if(items.length===0){el.innerHTML=`<option value="">Nenhum cadastrado</option>`;return;}el.innerHTML=`<option value="">${place}</option>`;items.forEach(i=>{const o=document.createElement('option');o.value=i.id;o.textContent=i[nameF]||i.name||'N/A';if(i.id===selId)o.selected=true;el.appendChild(o);});}catch(e){el.innerHTML=`<option value="">Erro</option>`;}}
        addWarrantyBtn.onclick=()=>{openModal('Nova Garantia',warrantyFormHTML(),async d=>{await addData(COLLECTIONS.WARRANTIES,d);loadWarranties();loadDashboardData();});populateSelectWithOptions('warrantyProductId',COLLECTIONS.PRODUCTS,'name');populateSelectWithOptions('warrantyCustomerId',COLLECTIONS.CUSTOMERS,'name');populateSelectWithOptions('warrantyMechanicId',COLLECTIONS.MECHANICS,'name',null,'Selecione Mecânico (Opcional)');};
        async function editWarranty(w){openModal('Editar Garantia',warrantyFormHTML(w),async d=>{await updateData(COLLECTIONS.WARRANTIES,w.id,d);loadWarranties();loadDashboardData();},w);populateSelectWithOptions('warrantyProductId',COLLECTIONS.PRODUCTS,'name',w.productId);populateSelectWithOptions('warrantyCustomerId',COLLECTIONS.CUSTOMERS,'name',w.customerId);populateSelectWithOptions('warrantyMechanicId',COLLECTIONS.MECHANICS,'name',w.mechanicId, 'Selecione Mecânico (Opcional)');}
        async function deleteWarranty(id){showConfirmModal('Excluir',`Excluir esta garantia?`,async()=>{try{await deleteData(COLLECTIONS.WARRANTIES,id);showModalMessage("Sucesso",`Garantia excluída.`);loadWarranties();loadDashboardData();}catch(e){showModalMessage("Erro",`Excluir garantia: ${e.message}`);}});};
        async function loadWarranties(){if(!isAuthReady||!db)return;warrantiesTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';try{const wars=await getData(COLLECTIONS.WARRANTIES);const prods=await getData(COLLECTIONS.PRODUCTS);const custs=await getData(COLLECTIONS.CUSTOMERS);const pMap=prods.reduce((m,i)=>{m[i.id]=i.name;return m;},{});const cMap=custs.reduce((m,i)=>{m[i.id]=i.name;return m;},{});if(wars.length===0){warrantiesTableBody.innerHTML='<tr><td colspan="5" class="text-center py-4">Nenhuma garantia.</td></tr>';return;}warrantiesTableBody.innerHTML='';wars.forEach(w=>{const r=warrantiesTableBody.insertRow();const sColor=w.status==="Aprovada"||w.status==="Produto trocado"||w.status==="Reparado"?'text-green-600':w.status==="Recusada"?'text-red-600':w.status==="Em análise"||w.status==="Aguardando peça"?'text-yellow-600':'text-gray-600';r.innerHTML=`<td class="py-3 px-4">${pMap[w.productId]||w.productId||'N/A'}</td><td class="py-3 px-4">${cMap[w.customerId]||w.customerId||'N/A'}</td><td class="py-3 px-4">${w.saleDate?new Date(w.saleDate+'T00:00:00').toLocaleDateString('pt-BR'):'N/A'}</td><td class="py-3 px-4 font-semibold ${sColor}">${w.status||'N/A'}</td><td class="py-3 px-4"><button class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button><button class="text-red-600"><i class="fas fa-trash"></i></button></td>`;r.querySelector('.fa-edit').parentElement.onclick=()=>editWarranty(w);r.querySelector('.fa-trash').parentElement.onclick=()=>deleteWarranty(w.id);});}catch(e){warrantiesTableBody.innerHTML=`<tr><td colspan="5" class="text-center py-4 text-red-500">Erro: ${e.message}</td></tr>`;}}

        // --- Dashboard Data ---
        async function loadDashboardData(){if(!isAuthReady||!db)return;try{const p=await getData(COLLECTIONS.PRODUCTS);const c=await getData(COLLECTIONS.CUSTOMERS);const w=await getData(COLLECTIONS.WARRANTIES);document.getElementById('totalProducts').textContent=p.length;document.getElementById('totalCustomers').textContent=c.length;const aW=w.filter(i=>i.status==="Em análise"||i.status==="Aguardando peça"||i.status==="Aprovada").length;document.getElementById('activeWarranties').textContent=aW;}catch(e){showModalMessage("Erro Dashboard",`Carregar dados: ${e.message}`);}}

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });

    </script>
</body>
</html>
